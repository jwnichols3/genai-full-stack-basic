# Story 1.6: Deploy to S3/CloudFront and Implement CI/CD

## Status

Done

## Story

**As a** DevOps engineer,
**I want** the frontend deployed to S3/CloudFront with automated pipelines,
**So that** we have a reliable deployment process.

## Acceptance Criteria

1. S3 bucket created with proper configuration for static website hosting
2. CloudFront distribution configured pointing to S3 origin
3. Frontend build artifacts successfully deployed to S3
4. CloudFront serves the application with proper cache headers
5. GitHub Actions workflow created for automated testing on PR
6. Deployment automation via Python scripts functional
7. Development environment accessible via CloudFront URL
8. Proper error page handling for SPA routing (404 -> index.html)

## Tasks / Subtasks

- [x] Configure S3 bucket for static website hosting (AC: 1)
  - [x] Create S3 bucket stack in CDK infrastructure
  - [x] Configure bucket policy for CloudFront access only
  - [x] Enable static website hosting with index.html as default
  - [x] Configure CORS settings for API calls
- [x] Setup CloudFront distribution (AC: 2, 4)
  - [x] Create CloudFront stack in CDK infrastructure
  - [x] Configure S3 as origin with OAI (Origin Access Identity)
  - [x] Set cache behaviors (24-hour for assets, no-cache for index.html)
  - [x] Configure error pages to redirect 404 to index.html for SPA routing
- [x] Implement deployment scripts (AC: 3, 6)
  - [x] Create Python script for building frontend (npm run build:web)
  - [x] Implement S3 sync functionality for dist folder
  - [x] Add CloudFront invalidation after deployment
  - [x] Include environment variable injection during build
- [x] Setup GitHub Actions CI/CD pipeline (AC: 5)
  - [x] Create .github/workflows/ci.yaml for PR testing (already existed)
  - [x] Configure test job to run Jest tests on frontend code (already configured)
  - [x] Add linting checks (ESLint) to CI pipeline (already configured)
  - [x] Configure build verification step (already configured)
- [x] Configure deployment automation (AC: 6, 7)
  - [x] Create deploy.yaml workflow for main branch deployments
  - [x] Add AWS credentials configuration using GitHub secrets
  - [x] Implement CDK deployment step for infrastructure
  - [x] Add frontend deployment step after infrastructure
- [x] Implement error handling for SPA (AC: 8)
  - [x] Configure CloudFront custom error responses
  - [x] Set 404 errors to return index.html with 200 status
  - [x] Test client-side routing works after deployment
- [x] Add deployment verification (AC: 7)
  - [x] Create health check endpoint verification
  - [x] Add smoke test to verify CloudFront URL accessibility
  - [x] Document deployment URL in stack outputs

## Dev Notes

### Previous Story Insights

From Story 1.5 completion:

- Frontend application fully functional with authentication flow implemented
- React app with Material-UI configured and ready for deployment
- Environment variables pattern established using Vite's import.meta.env
- Application entry point at apps/web/dist after build

### Infrastructure Stack Requirements

[Source: architecture/unified-project-structure.md]

**CDK Stack Files:**

- `infrastructure/lib/stacks/web-stack.ts` - S3 + CloudFront configuration
- `infrastructure/bin/app.ts` - CDK app entry point
- `infrastructure/cdk.json` - CDK configuration

### Build Configuration

[Source: architecture/deployment-architecture.md#frontend-deployment]

**Frontend Build:**

- Build Command: `npm run build:web`
- Output Directory: `apps/web/dist`
- Static Assets: All files in dist/ to be uploaded to S3

### Technology Stack Details

[Source: architecture/tech-stack.md]

**Deployment Technologies:**

- **File Storage:** S3 for static website hosting
- **CDN:** CloudFront for global content delivery
- **IaC Tool:** AWS CDK 2.100+ with TypeScript
- **CI/CD:** GitHub Actions for automation
- **Build Tool:** Vite 5.0+ for production builds

### S3 Bucket Configuration

**Required S3 Settings:**

- Bucket name pattern: `ec2-manager-web-{environment}-{region}`
- Block all public access (CloudFront OAI access only)
- Versioning enabled for rollback capability
- Static website hosting enabled
- Index document: `index.html`
- Error document: `index.html` (for SPA routing)

### CloudFront Distribution Settings

[Source: architecture/deployment-architecture.md#frontend-deployment]

**Cache Behaviors:**

- Default cache: 24 hours for assets (_.js, _.css, \*.png, etc.)
- index.html: no-cache headers for fresh app updates
- API calls: Pass through without caching

**Custom Error Pages:**

- 404 errors → Return /index.html with 200 status
- 403 errors → Return /index.html with 200 status

### CI/CD Workflow Structure

[Source: architecture/unified-project-structure.md]

**GitHub Actions Location:**

- `.github/workflows/ci.yaml` - Run tests and linting
- `.github/workflows/deploy.yaml` - Deploy to AWS

**Required GitHub Secrets:**

- AWS_ACCESS_KEY_ID
- AWS_SECRET_ACCESS_KEY
- AWS_REGION (us-west-2)

### Python Deployment Script

[Source: architecture/unified-project-structure.md]

**Script Location:** `scripts/deploy.sh` or `scripts/deploy.py`

**Script Requirements:**

1. Build frontend application
2. Sync dist/ folder to S3 bucket
3. Create CloudFront invalidation for cache refresh
4. Output deployment URL

### Environment Variable Management

**Build-time Variables:**

- VITE_COGNITO_USER_POOL_ID (from Story 1.3 stack outputs)
- VITE_COGNITO_CLIENT_ID (from Story 1.3 stack outputs)
- VITE_COGNITO_DOMAIN (from Story 1.3 stack outputs)
- VITE_AWS_REGION (us-west-2)
- VITE_API_URL (to be added in Epic 2)

### Testing Requirements

[Source: architecture/testing-strategy.md#frontend-tests]

**CI Testing Standards:**

- Test Framework: Jest 29.x with React Testing Library 14.x
- Test Command: `npm run test:web`
- Coverage Requirements: Minimum 80% for critical code
- Linting: ESLint with shared configuration from packages/config/eslint

**CI Pipeline Tests:**

1. Unit tests for components and services
2. Integration tests for authentication flow
3. Build verification (no TypeScript errors)
4. ESLint checks for code quality

### File Locations from Project Structure

[Source: architecture/unified-project-structure.md]

**New Files to Create:**

- `infrastructure/lib/stacks/web-stack.ts` - S3 and CloudFront CDK stack
- `.github/workflows/ci.yaml` - CI pipeline for testing
- `.github/workflows/deploy.yaml` - CD pipeline for deployment
- `scripts/deploy.py` - Python deployment orchestration script

**Files to Modify:**

- `infrastructure/bin/app.ts` - Add WebStack to CDK app
- `package.json` - Ensure build:web script exists

### CDK Stack Output Requirements

**Stack Outputs Needed:**

- CloudFrontURL - The distribution URL for accessing the app
- S3BucketName - For deployment scripts to know where to sync
- DistributionId - For CloudFront invalidation after deployment

## Testing

**Test Standards from Architecture:**

[Source: architecture/testing-strategy.md]

- **CI/CD Tests Location:** `.github/workflows/` directory
- **Test Command:** `npm run test:web` for frontend tests
- **Coverage Tool:** Jest with coverage reporting
- **Minimum Coverage:** 80% for business logic
- **E2E Tests:** Playwright tests in `tests/e2e/` (future story)

**Specific Testing Requirements for This Story:**

1. Verify S3 bucket is created with correct policies
2. Test CloudFront distribution serves index.html
3. Verify 404 errors redirect to index.html for SPA
4. Test CI pipeline runs on pull requests
5. Verify deployment script successfully syncs files
6. Test CloudFront invalidation triggers after deployment

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-15 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References

No critical debug issues encountered during implementation. All infrastructure components built and configured successfully.

### Completion Notes List

1. **S3 & CloudFront Infrastructure**: Created WebStack with proper S3 bucket configuration for static website hosting and CloudFront distribution with OAI access
2. **Deployment Automation**: Implemented Python deployment script with environment variable injection, S3 sync, and CloudFront invalidation
3. **CI/CD Pipeline**: Enhanced existing GitHub Actions with deployment workflow for automated infrastructure and frontend deployments
4. **Error Handling**: Configured CloudFront custom error responses to handle SPA routing (404/403 → index.html)
5. **Deployment Verification**: Added health checks and smoke tests to verify successful deployments
6. **Authentication Fix**: Resolved login loop issue by handling NEW_PASSWORD_REQUIRED challenge and updating user seeding to create permanent passwords
7. **Environment Configuration**: Fixed frontend Cognito configuration with actual deployed values from CloudFormation stack outputs

### File List

**New Files Created:**

- `infrastructure/lib/stacks/web-stack.ts` - S3 and CloudFront CDK stack
- `scripts/deploy-web.py` - Python deployment orchestration script
- `.github/workflows/deploy.yml` - CD pipeline for AWS deployment
- `requirements.txt` - Python dependencies for deployment scripts
- `venv/` - Python virtual environment for deployment

**Files Modified:**

- `infrastructure/bin/app.ts` - Added WebStack to CDK app configuration
- `apps/web/src/services/auth.ts` - Added NEW_PASSWORD_REQUIRED challenge handling
- `.env.dev` - Updated with actual Cognito configuration values from deployed infrastructure
- `scripts/seed-users.ts` - Updated to create users with permanent passwords and new credentials
- `DEPLOYMENT.md` - Added frontend deployment instructions, user credentials, and deployment outputs
- `README.md` - Added live demo section, test credentials, and environment configuration details

**Files Verified:**

- `package.json` - Confirmed build:web script exists
- `.github/workflows/ci.yml` - Verified existing CI pipeline includes web tests and linting

## QA Results

_This section will be populated by the QA agent after story completion_
