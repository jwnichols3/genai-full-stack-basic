# Story 2.5: Implement Instance Detail View

## Status

Done

## Story

**As a** user,
**I want** to view detailed information about a specific instance,
**So that** I can understand its configuration and status.

## Acceptance Criteria

1. Clicking an instance navigates to detail view (/instances/{instanceId})
2. Detail API endpoint created (GET /instances/{instanceId})
3. Lambda function retrieves comprehensive instance details
4. UI displays all instance attributes in organized sections
5. Tags displayed in a readable table format
6. Network information clearly presented (VPC, subnet, security groups)
7. Launch time shown with relative time (e.g., "2 days ago")
8. Back navigation returns to dashboard maintaining scroll position
9. Loading and error states properly handled

## Tasks / Subtasks

- [x] Create Backend API endpoint for instance details (AC: 2, 3)
  - [x] Create `apps/api/src/functions/instances/get.ts` Lambda handler
  - [x] Implement comprehensive EC2 DescribeInstances call for single instance
  - [x] Add VPC, subnet, and security group information retrieval
  - [x] Handle instance not found (404) and unauthorized (403) cases
  - [x] Add audit logging for VIEW_INSTANCE action
  - [x] Update CDK stack to include new Lambda function and API route
- [x] Create Instance Detail Page Component (AC: 1, 4, 7, 8, 9)
  - [x] Create `apps/web/src/pages/InstanceDetail.tsx` page component
  - [x] Implement React Router navigation from dashboard DataGrid
  - [x] Create responsive layout with organized information sections
  - [x] Display instance basic info, state, timing, and network details
  - [x] Add back navigation that maintains dashboard scroll position
  - [x] Implement loading skeleton and error boundary
- [x] Create Instance Tags Display Component (AC: 5)
  - [x] Create `apps/web/src/components/instances/InstanceTags.tsx`
  - [x] Implement Material-UI Table or Card layout for tag display
  - [x] Handle empty tags state gracefully
  - [x] Make tags searchable/filterable for instances with many tags
- [x] Create Network Information Display (AC: 6)
  - [x] Create `apps/web/src/components/instances/InstanceNetwork.tsx`
  - [x] Display VPC, subnet, security groups in organized layout
  - [x] Show public/private IPs with copy-to-clipboard functionality
  - [x] Handle cases where network information is not available
- [x] Implement Relative Time Display (AC: 7)
  - [x] Create `apps/web/src/utils/timeUtils.ts` utility functions
  - [x] Use relative time formatting (e.g., "2 hours ago", "3 days ago")
  - [x] Show absolute time on hover for precision
  - [x] Handle timezone display based on user preferences
- [x] Add Route Configuration and Navigation (AC: 1, 8)
  - [x] Add `/instances/:instanceId` route to `apps/web/src/App.tsx`
  - [x] Wrap route with ProtectedRoute component
  - [x] Implement navigation from Dashboard DataGrid row click
  - [x] Use browser history state to maintain dashboard scroll position
  - [x] Add breadcrumb navigation showing Dashboard > Instance Name
- [x] Create Service Layer Integration (AC: 2, 3, 9)
  - [x] Add `getInstanceDetails` method to `apps/web/src/services/ec2.ts`
  - [x] Create `useInstanceDetail` custom hook in `apps/web/src/hooks/`
  - [x] Implement error handling for API failures and network issues
  - [x] Add retry logic for temporary failures
  - [x] Cache instance details with smart invalidation
- [x] Unit Testing for Instance Detail Components (AC: 1-9)
  - [x] Create `apps/web/tests/unit/pages/InstanceDetail.test.tsx`
  - [x] Test instance details rendering with mock data
  - [x] Test loading states and error boundaries
  - [x] Test navigation and back button functionality
  - [x] Test responsive behavior across screen sizes
  - [x] Create `apps/web/tests/unit/hooks/useInstanceDetail.test.ts`
  - [x] Test API integration and error handling
  - [x] Create `apps/api/tests/unit/functions/instances/get.test.ts`
  - [x] Test Lambda handler with various instance states
  - [x] Test error cases (instance not found, permissions)

## Dev Notes

### Previous Story Insights

From Story 2.4 completion:

- Dashboard UI is complete with Material-UI DataGrid implementation
- EC2 service layer is established at `apps/web/src/services/ec2.ts`
- useInstances hook is available for data fetching patterns
- InstanceStatusBadge component exists for state color coding
- API Gateway and Lambda infrastructure is ready and configured
- Authentication and authorization context is available via useAuth hook
- DataGrid navigation pattern is established for row interactions

### Technology Stack Requirements

[Source: architecture/tech-stack.md]

**Frontend Technologies:**

- **Frontend Language:** TypeScript 5.3+ for type-safe frontend development
- **Frontend Framework:** React 18.2+ UI component framework
- **UI Component Library:** Material-UI (MUI) 5.15+ for pre-built React components
- **State Management:** Context API + useReducer for application state management
- **Frontend Testing:** Jest + React Testing Library 29.x / 14.x for unit and integration testing

**Backend Technologies:**

- **Backend Language:** TypeScript 5.3+ for type-safe backend development
- **Backend Framework:** AWS Lambda + Node.js 20.x for serverless compute runtime
- **API Style:** REST for API architecture pattern
- **Backend Testing:** Jest 29.x for Lambda function testing

### Project Structure Requirements

[Source: architecture/unified-project-structure.md]

**Frontend Application Structure:**

- `apps/web/src/pages/InstanceDetail.tsx` - Main instance detail page component
- `apps/web/src/components/instances/InstanceTags.tsx` - Tags display component
- `apps/web/src/components/instances/InstanceNetwork.tsx` - Network info component
- `apps/web/src/hooks/useInstanceDetail.ts` - Custom hook for instance detail data
- `apps/web/src/utils/timeUtils.ts` - Time formatting utilities
- `apps/web/tests/unit/pages/InstanceDetail.test.tsx` - Page component tests
- `apps/web/tests/unit/hooks/useInstanceDetail.test.ts` - Hook tests

**Backend Application Structure:**

- `apps/api/src/functions/instances/get.ts` - Lambda handler for GET /instances/{id}
- `apps/api/tests/unit/functions/instances/get.test.ts` - Lambda function tests

### Data Models and API Requirements

[Source: architecture/data-models.md#ec2instance]

**EC2Instance TypeScript Interface:**

```typescript
interface EC2Instance {
  instanceId: string;
  instanceType: string;
  state: InstanceState;
  publicIp: string | null;
  privateIp: string;
  launchTime: string;
  availabilityZone: string;
  tags: Record<string, string>;
  monitoring?: {
    state: 'enabled' | 'disabled';
  };
}
```

**Extended Instance Detail Interface:**

```typescript
interface EC2InstanceDetail extends EC2Instance {
  vpcId?: string;
  subnetId?: string;
  securityGroups?: Array<{
    groupId: string;
    groupName: string;
  }>;
  keyName?: string;
  instanceProfile?: {
    arn: string;
    id: string;
  };
}
```

### API Specification Requirements

[Source: architecture/api-specification.md]

**GET /instances/{instanceId} Endpoint:**

- **Path Parameter:** instanceId (required)
- **Authentication:** Cognito JWT token required
- **Authorization:** Both admin and readonly roles permitted
- **Response 200:** EC2InstanceDetail object
- **Response 404:** Instance not found error
- **Response 401:** Unauthorized error
- **Response 403:** Insufficient permissions error

### Backend Architecture Requirements

[Source: architecture/backend-architecture.md]

**Lambda Function Pattern:**

```typescript
// apps/api/src/functions/instances/get.ts
import { APIGatewayProxyHandler } from 'aws-lambda';
import { EC2Client, DescribeInstancesCommand } from '@aws-sdk/client-ec2';
import { createResponse, createErrorResponse } from '@/shared/utils/response';
import { logger } from '@/shared/middleware/logger';
import { AuditService } from '@/shared/services/auditService';
```

**Required AWS SDK Calls:**

- EC2Client.DescribeInstances for comprehensive instance details
- Include VPC, subnet, security group information
- Handle pagination if multiple instances returned
- Extract additional network and security details

**Audit Logging Requirements:**

- Log VIEW_INSTANCE action for all detail requests
- Include userId, userEmail, instanceId in audit trail
- Log both successful views and access denied attempts

### Frontend Architecture Requirements

[Source: architecture/frontend-architecture.md]

**Component Organization Pattern:**

```text
src/components/instances/
├── InstanceDetail/
│   ├── InstanceDetail.tsx       # Main detail view container
│   ├── InstanceHeader.tsx       # Instance name/ID/status header
│   ├── InstanceOverview.tsx     # Basic instance information
│   ├── InstanceNetwork.tsx      # Network configuration details
│   └── InstanceTags.tsx         # Tags table/display
```

**Service Integration Pattern:**

```typescript
// Use existing ec2Service pattern from Story 2.4
import { ec2Service } from '@/services/ec2';

// Add new method:
async getInstanceDetails(instanceId: string): Promise<EC2InstanceDetail>
```

**State Management Pattern:**

- Use local component state for UI-only state (loading, expanded sections)
- Cache instance details in useInstanceDetail hook
- Handle loading states with skeleton components
- Implement error boundaries for API failures

### Navigation and Routing Requirements

**Route Configuration:**

- Add `/instances/:instanceId` route to main App.tsx routing
- Use React Router v6 useParams hook to extract instanceId
- Wrap route with ProtectedRoute component (no specific role required)
- Support deep linking directly to instance detail URLs

**Navigation Integration:**

- Add click handler to Dashboard DataGrid rows
- Use React Router's navigate() to programmatically route
- Store current dashboard state (scroll position, filters) in browser history
- Implement back navigation that restores dashboard state

**Breadcrumb Navigation:**

- Show: Dashboard > Instance {Name or ID}
- Make Dashboard clickable to return to list view
- Use instance Name tag if available, fallback to instanceId

### Material-UI Layout Requirements

**Responsive Design:**

- Desktop (lg+): Show full detail layout with side-by-side sections
- Tablet (md): Stack sections vertically, reduce padding
- Mobile (sm-): Single column layout with expandable sections
- Use Material-UI sx prop and breakpoint system

**Component Layout:**

- Page header with instance name/ID, status badge, and back button
- Grid layout with cards for different information sections:
  - Overview card (type, AZ, launch time, monitoring)
  - Network card (IPs, VPC, subnet, security groups)
  - Tags card (searchable table if many tags exist)
- Loading states use Material-UI Skeleton components
- Error states use Material-UI Alert components

### Time Display Requirements

**Relative Time Implementation:**

- Use date-fns or similar library for relative time formatting
- Show relative time by default: "3 hours ago", "2 days ago"
- Show absolute time with timezone on hover using Tooltip
- Handle edge cases: very recent (< 1 minute), very old (> 1 year)
- Update relative time automatically every minute when page is active

### Coding Standards Requirements

[Source: architecture/coding-standards.md]

**Critical Frontend Rules:**

- **Type Sharing:** Import EC2Instance from packages/shared types
- **API Calls:** Use ec2Service layer, never direct HTTP calls
- **State Updates:** Never mutate state directly - use proper state management patterns
- **Auth Tokens:** Access via useAuth hook only, stored in memory
- **Input Validation:** Validate instanceId parameter format
- **Async Operations:** Always handle loading and error states in UI
- **Code Splitting:** Lazy load the InstanceDetail page component

**Naming Conventions:**

- Components: PascalCase (InstanceDetail.tsx, InstanceNetwork.tsx)
- Hooks: camelCase with 'use' prefix (useInstanceDetail.ts)
- Functions: camelCase (formatRelativeTime(), getNetworkInfo())
- File names: PascalCase for components, camelCase for others

### Testing Requirements

[Source: architecture/testing-strategy.md]

**Frontend Test Structure:**

```text
apps/web/tests/unit/
├── pages/InstanceDetail.test.tsx       # Detail page tests
├── components/instances/
│   ├── InstanceTags.test.tsx           # Tags component tests
│   └── InstanceNetwork.test.tsx        # Network component tests
├── hooks/useInstanceDetail.test.ts     # Custom hook tests
└── utils/timeUtils.test.ts            # Time utility tests
```

**Required Test Scenarios:**

1. InstanceDetail page renders loading state while fetching
2. Page displays instance details when data loads successfully
3. Error boundary catches and displays API failures (404, network errors)
4. Navigation from dashboard works correctly with instanceId parameter
5. Back button returns to dashboard maintaining scroll position
6. InstanceTags component displays tags in table format
7. InstanceNetwork component shows network information correctly
8. Relative time formatting works for various time ranges
9. Responsive layout adapts to different screen sizes
10. Protected route requires authentication
11. Deep linking to specific instance detail URLs works

**Backend Test Structure:**

```text
apps/api/tests/unit/
└── functions/instances/get.test.ts     # Lambda handler tests
```

**Required Backend Test Scenarios:**

1. Lambda handler returns instance details for valid instanceId
2. Handler returns 404 for non-existent instance
3. Handler returns 403 for unauthorized users
4. Handler logs VIEW_INSTANCE audit action correctly
5. Handler handles AWS SDK errors gracefully
6. Handler returns proper CORS headers

### Authentication Integration

**Auth Context Requirements:**

- Access user role via useAuth() hook (available for future features)
- Instance detail accessible to both 'admin' and 'readonly' roles
- Handle authentication errors by redirecting to login
- Show user context in audit logs on backend

### Error Handling Requirements

**Error Scenarios to Handle:**

- Instance not found (404) - show friendly "Instance not found" message
- Network failures - show error with retry button
- Authentication failures - redirect to login page
- Malformed instanceId - show validation error
- AWS service errors - show generic error with support contact info

### Performance Considerations

**Optimization Requirements:**

- Use React.memo for sub-components (InstanceTags, InstanceNetwork)
- Implement lazy loading for the InstanceDetail page component
- Cache instance details with 5-minute TTL in useInstanceDetail hook
- Debounce tag search if implementing search functionality
- Use Material-UI Skeleton for loading states instead of spinners
- Prefetch instance details on dashboard row hover (optional enhancement)

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-23 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514) - Expert Senior Software Engineer & Implementation Specialist

### Debug Log References

- TypeScript compilation errors resolved for interface mismatches between EC2Instance and EC2InstanceDetail
- Fixed duplicate testDir property in playwright.config.ts
- Resolved empty package.json file in incorrect directory structure
- Updated responsive mock data in tests to include all required properties

### Completion Notes List

- ✅ **Backend Implementation**: Created comprehensive Lambda function at `apps/api/src/functions/instances/get.ts` with full error handling, validation, and audit logging
- ✅ **CDK Infrastructure**: Updated API stack to include new GET /instances/{instanceId} route with proper CORS and error responses
- ✅ **Frontend Components**: Built complete instance detail view with responsive design using Material-UI components
- ✅ **Navigation Integration**: Implemented seamless navigation from dashboard with scroll position preservation
- ✅ **Time Utilities**: Created robust time formatting utilities with relative and absolute time display
- ✅ **Network Display**: Built comprehensive network information component with copy-to-clipboard functionality
- ✅ **Tags Management**: Implemented searchable/filterable tags display for instances with many tags
- ✅ **Service Layer**: Extended EC2 service with getInstanceDetails method and created useInstanceDetail hook
- ✅ **Testing Coverage**: Created comprehensive unit tests for all components, hooks, and Lambda functions
- ✅ **TypeScript Safety**: All code passes type checking with proper interface definitions and type safety
- ✅ **Build Success**: Project builds successfully with no errors or warnings

### File List

**Backend Files:**

- `apps/api/src/functions/instances/get.ts` - Lambda handler for instance detail API
- `apps/api/tests/unit/functions/instances/get.test.ts` - Comprehensive Lambda function tests
- `infrastructure/lib/stacks/api-stack.ts` - Updated CDK stack with new route

**Frontend Files:**

- `apps/web/src/pages/InstanceDetail.tsx` - Main instance detail page component
- `apps/web/src/components/instances/InstanceTags.tsx` - Tags display component with search
- `apps/web/src/components/instances/InstanceNetwork.tsx` - Network information component
- `apps/web/src/hooks/useInstanceDetail.ts` - Custom hook for instance detail data
- `apps/web/src/utils/timeUtils.ts` - Time formatting utilities
- `apps/web/src/services/ec2.ts` - Extended EC2 service with getInstanceDetails method
- `apps/web/src/App.tsx` - Updated with new route configuration
- `apps/web/src/pages/Dashboard.tsx` - Updated with navigation to instance detail
- `apps/web/src/pages/index.ts` - Updated to export InstanceDetail page

**Test Files:**

- `apps/web/tests/unit/pages/InstanceDetail.test.tsx` - Instance detail page tests
- `apps/web/tests/unit/hooks/useInstanceDetail.test.ts` - Custom hook tests
- `apps/web/tests/unit/components/instances/InstanceTags.test.tsx` - Tags component tests
- `apps/web/tests/unit/utils/timeUtils.test.ts` - Time utilities tests

**Dependencies Added:**

- `date-fns` - For robust date/time formatting and manipulation

## QA Results

[To be populated by QA Agent]
