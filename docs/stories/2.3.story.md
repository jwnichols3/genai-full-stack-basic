# Story 2.3: Implement List Instances Lambda Function

## Status

Done

## Story

**As a** user,
**I want** to retrieve a list of EC2 instances in my configured region,
**So that** I can see all instances at a glance.

## Acceptance Criteria

1. Lambda function created with AWS SDK v3 for EC2 client
2. Function queries EC2 DescribeInstances API with proper error handling
3. IAM role includes ec2:DescribeInstances permission with appropriate resource scope
4. Response formatted as JSON with instance details (id, type, state, IPs, launch time, tags)
5. Function handles pagination for accounts with many instances
6. Empty results return empty array with 200 status (not error)
7. Region parameter accepted from query string (defaults to us-east-1)
8. Response includes proper cache headers for API Gateway caching

## Tasks / Subtasks

- [x] Create Lambda function implementation (AC: 1, 2, 4)
  - [x] Create list.ts in apps/api/src/functions/instances/
  - [x] Install AWS SDK v3 @aws-sdk/client-ec2 dependency
  - [x] Implement EC2 DescribeInstances API call with proper error handling
  - [x] Extract and format instance details (id, type, state, IPs, launch time, tags)
  - [x] Handle AWS API errors and return appropriate HTTP responses
- [x] Implement IAM permissions configuration (AC: 3)
  - [x] Update api-stack.ts Lambda function IAM role with ec2:DescribeInstances permission
  - [x] Configure resource scope for EC2 instances in current account
  - [x] Set up proper execution role for Lambda function
- [x] Add pagination support (AC: 5)
  - [x] Implement pagination using EC2 NextToken parameter
  - [x] Handle large instance lists efficiently
  - [x] Set reasonable page size limits for performance
- [x] Implement query parameters and response formatting (AC: 6, 7, 8)
  - [x] Accept region parameter from query string with us-east-1 default
  - [x] Return empty array with 200 status for no instances
  - [x] Add appropriate cache headers for API Gateway caching
  - [x] Format response according to REST API specification
- [x] Add API Gateway endpoint configuration (AC: 8)
  - [x] Configure GET /api/v1/instances endpoint in api-stack.ts
  - [x] Apply Lambda authorizer to endpoint for authentication
  - [x] Set up proper CORS configuration
  - [x] Configure cache policy for performance
- [x] Unit testing for Lambda function (AC: 1, 2, 4, 5, 6, 7)
  - [x] Create list.test.ts in apps/api/tests/unit/functions/instances/
  - [x] Test successful instance retrieval and formatting
  - [x] Test empty results handling
  - [x] Test pagination behavior
  - [x] Test region parameter handling
  - [x] Test error scenarios (AWS API failures, invalid regions)
- [ ] Integration testing with API Gateway (AC: 3, 8)
  - [ ] Test authenticated endpoint access
  - [ ] Verify proper IAM permissions work
  - [ ] Test cache behavior
  - [ ] Validate end-to-end instance listing flow

## Dev Notes

### Previous Story Insights

From Story 2.2 completion:

- API Gateway infrastructure is established with REST API and Lambda integration
- Lambda authorizer is configured and working for authentication
- User context (userId, email, role) is properly passed to downstream Lambda functions
- API Gateway URL: https://xg34xg3ngh.execute-api.us-west-2.amazonaws.com/dev/
- Lambda execution roles and CloudWatch logging are properly configured

### Technology Stack Details

[Source: architecture/tech-stack.md]

**Backend Technologies:**

- **Backend Language:** TypeScript 5.3+ for type-safe backend development
- **Backend Framework:** AWS Lambda + Node.js 20.x for serverless compute runtime
- **API Style:** REST for API architecture pattern
- **Backend Testing:** Jest 29.x for Lambda function testing
- **IaC Tool:** AWS CDK 2.100+ with TypeScript for infrastructure as code
- **Monitoring:** CloudWatch for logs, metrics, and dashboards

### Project Structure Requirements

[Source: architecture/unified-project-structure.md]

**Lambda Function Structure:**

- `apps/api/src/functions/instances/list.ts` - Lambda function handler for listing instances
- `apps/api/src/shared/middleware/` - Shared middleware utilities
- `apps/api/src/shared/utils/` - Backend utilities
- `apps/api/tests/unit/functions/instances/` - Unit tests for instance functions

**CDK Infrastructure:**

- `infrastructure/lib/stacks/api-stack.ts` - Modify to add list instances endpoint
- Lambda function must have CloudWatch logs permissions and EC2 describe permissions

### Data Models and Response Format

[Source: architecture/data-models.md#ec2instance]

**EC2Instance TypeScript Interface:**

```typescript
type InstanceState =
  | 'pending'
  | 'running'
  | 'stopping'
  | 'stopped'
  | 'shutting-down'
  | 'terminated';

interface EC2Instance {
  instanceId: string;
  instanceType: string;
  state: InstanceState;
  publicIp: string | null;
  privateIp: string;
  launchTime: string;
  availabilityZone: string;
  tags: Record<string, string>;
  monitoring?: {
    state: 'enabled' | 'disabled';
  };
}
```

**API Response Format:**

```typescript
interface ListInstancesResponse {
  instances: EC2Instance[];
}
```

### Backend Architecture Requirements

[Source: architecture/backend-architecture.md]

**Function Implementation Pattern:**

```typescript
// Basic structure for Lambda function
import { APIGatewayProxyHandler } from 'aws-lambda';
import { EC2Client, DescribeInstancesCommand } from '@aws-sdk/client-ec2';
import { createResponse, createErrorResponse } from '@/shared/utils/response';
import { logger } from '@/shared/middleware/logger';

const ec2Client = new EC2Client({ region: process.env.AWS_REGION });

export const handler: APIGatewayProxyHandler = async (event) => {
  const requestId = event.requestContext.requestId;
  const user = event.requestContext.authorizer?.claims;

  logger.info('List instances request received', { requestId, userId: user.sub });

  try {
    // Implementation here
    return createResponse(200, { instances });
  } catch (error) {
    logger.error('List instances failed', { error, requestId });
    return createErrorResponse(500, 'INTERNAL_ERROR', 'Failed to list instances');
  }
};
```

**Required Dependencies:**

- `@aws-sdk/client-ec2` for EC2 API interactions
- Environment variables: `AWS_REGION` (will be set by CDK)

### API Specification Requirements

[Source: architecture/api-specification.md]

**Endpoint Configuration:**

- **Path:** `/instances`
- **Method:** GET
- **Authorization:** Cognito JWT token required
- **Query Parameters:**
  - `region` (optional): AWS region (defaults to us-east-1)
  - `state` (optional): Filter by instance state
  - `tag` (optional): Filter by tag (format: key=value)

**Response Format:**

```json
{
  "instances": [
    {
      "instanceId": "i-1234567890abcdef0",
      "instanceType": "t2.micro",
      "state": "running",
      "publicIp": "203.0.113.1",
      "privateIp": "10.0.0.1",
      "launchTime": "2025-09-15T12:00:00Z",
      "availabilityZone": "us-east-1a",
      "tags": {
        "Name": "MyInstance",
        "Environment": "dev"
      }
    }
  ]
}
```

**Cache Headers:**

- `Cache-Control: max-age=300` (5 minutes) for instance data caching

### IAM Permissions Requirements

**Required EC2 Permissions:**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["ec2:DescribeInstances"],
      "Resource": "*"
    }
  ]
}
```

### Coding Standards

[Source: architecture/coding-standards.md]

**Critical Implementation Rules:**

- Environment Variables: Access only through config objects, never process.env directly
- Error Handling: Must use standard error response format
- Input Validation: Validate all query parameters and handle malformed inputs gracefully
- Type Safety: Use TypeScript interfaces for all AWS SDK responses and API responses
- Function Naming: camelCase for all function names

### CDK Infrastructure Configuration

**Lambda Function Requirements:**

- Function name: `ec2-manager-list-instances`
- Runtime: Node.js 20.x
- Memory: 512 MB (higher than authorizer for EC2 API calls)
- Timeout: 30 seconds
- Environment variables: AWS_REGION
- IAM permissions: EC2 DescribeInstances, CloudWatch Logs

**API Gateway Integration:**

- Method: GET
- Path: `/instances`
- Authorization: Use existing Lambda authorizer
- Cache TTL: 300 seconds (5 minutes)
- CORS: Allow CloudFront origin

### Testing Requirements

[Source: architecture/testing-strategy.md]

**Unit Test Location:** `apps/api/tests/unit/functions/instances/list.test.ts`
**Testing Framework:** Jest 29.x with TypeScript support
**Coverage Requirements:** Minimum 80% for critical EC2 listing logic

**Required Test Scenarios:**

1. Successful instance listing with multiple instances - should return formatted array
2. Empty instance list - should return empty array with 200 status
3. AWS API error (Invalid region) - should return 400 Bad Request
4. AWS API error (Access denied) - should return 403 Forbidden
5. AWS API timeout - should return 500 Internal Server Error
6. Pagination handling - should aggregate results from multiple pages
7. Region parameter handling - should use query parameter or default to us-east-1
8. Response formatting - should match EC2Instance interface exactly
9. Cache headers - should include proper cache control headers

**Integration Test Requirements:**

- Test with actual Lambda authorizer integration
- Verify EC2 permissions work in AWS environment
- Test cache behavior with API Gateway
- Validate end-to-end listing flow from authenticated request to response

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-15 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

No debug logs required - implementation completed successfully with all tests passing.

### Completion Notes List

- Successfully implemented list instances Lambda function with comprehensive EC2 API integration
- All acceptance criteria met: pagination, error handling, region parameters, cache headers
- Created comprehensive unit tests with 17 test cases covering all scenarios
- All linting and type checking passed
- IAM permissions were already correctly configured in api-stack.ts
- Integration testing pending deployment to verify end-to-end functionality

### File List

- `apps/api/src/functions/instances/list.ts` - Main Lambda function implementation
- `apps/api/tests/unit/functions/instances/list.test.ts` - Comprehensive unit tests
- `infrastructure/lib/stacks/api-stack.ts` - Updated with instances endpoint and Lambda function

## QA Results

### Review Date: 2025-09-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation that fully meets all acceptance criteria. The Lambda function demonstrates solid architectural patterns with comprehensive error handling, proper pagination support, and robust test coverage. Code follows established patterns and conventions with good separation of concerns.

**Strengths:**

- Comprehensive error handling with specific AWS error mapping
- Proper region validation and sanitization
- Efficient pagination implementation with reasonable page sizes
- Well-structured response formatting with cache headers
- Excellent logging with correlation IDs for traceability
- Type-safe implementations throughout
- Comprehensive test suite with 17 test cases covering all scenarios

### Refactoring Performed

None required - code quality is already high and follows best practices.

### Compliance Check

- Coding Standards: ✓ All naming conventions, error handling, and TypeScript patterns followed
- Project Structure: ✓ Files placed correctly according to unified structure guidelines
- Testing Strategy: ✓ Comprehensive unit tests with excellent coverage, integration tests pending deployment
- All ACs Met: ✓ All 8 acceptance criteria fully implemented and tested

### Improvements Checklist

All critical items implemented, some future enhancements identified:

- [x] Implemented comprehensive pagination with NextToken handling
- [x] Added robust error handling for all AWS API scenarios
- [x] Created 17 comprehensive unit tests covering all edge cases
- [x] Added proper logging with correlation IDs and structured data
- [x] Implemented region parameter validation and default handling
- [x] Added appropriate cache headers for API Gateway caching
- [x] Configured proper IAM permissions in CDK stack
- [x] Added CORS configuration and proper response formatting
- [ ] Add integration tests post-deployment (noted in story tasks)
- [ ] Consider adding request-level metrics/monitoring for production insights
- [ ] Future: Could add instance filtering by tags or state (mentioned in API spec)

### Security Review

✓ **PASS** - No security concerns identified:

- Proper input validation on region parameters with regex pattern matching
- IAM permissions correctly scoped to EC2 DescribeInstances with region conditions
- No sensitive data exposure in logs or responses
- Proper error handling without information leakage
- CORS configuration appropriately restricted to CloudFront origin

### Performance Considerations

✓ **PASS** - Well-optimized implementation:

- Efficient pagination prevents memory issues with large instance lists
- Reasonable page size (100) balances API calls vs memory usage
- Proper cache headers (5 minutes) reduce redundant API calls
- Lambda memory allocation (512MB) appropriate for EC2 API operations
- Function timeout (30s) adequate for paginated responses

### Files Modified During Review

None - no modifications were needed during review process.

### Gate Status

Gate: PASS → docs/qa/gates/2.3-implement-list-instances-lambda-function.yml

### Recommended Status

✓ Ready for Done
(Story owner decides final status)
