# Story 2.8: Implement Role-Based UI Adaptation

## Status

Approved

## Story

**As a** read-only user,
**I want** to see only the features available to my role,
**So that** the interface isn't cluttered with unavailable actions.

## Acceptance Criteria

1. User role retrieved from JWT token and stored in React context
2. Admin-only UI elements hidden for read-only users
3. Navigation menu adapts based on user role
4. Dashboard shows role indicator in header
5. Tooltip on disabled features explains permission requirement
6. Role context available throughout component tree
7. UI prevents attempting unauthorized actions client-side
8. Profile section displays current user email and role

## Tasks / Subtasks

### Role Context Management (AC: 1, 6)

- [ ] **Extract user role from JWT token in authentication service** (AC: 1)
  - [ ] Update AuthContext to extract role from token claims
  - [ ] Store role in auth state alongside user information
  - [ ] Ensure role is available throughout component tree via context

### UI Element Role Adaptation (AC: 2, 7)

- [ ] **Hide admin-only UI elements for read-only users** (AC: 2, 7)
  - [ ] Update InstanceListItem component to conditionally show reboot button
  - [ ] Update instance actions to check user role before rendering
  - [ ] Implement role-based component rendering utilities

### Navigation Role Adaptation (AC: 3)

- [ ] **Adapt navigation menu based on user role** (AC: 3)
  - [ ] Update Header/Sidebar navigation to show role-appropriate menu items
  - [ ] Hide admin-only routes from navigation for read-only users
  - [ ] Ensure consistent navigation experience across role types

### Role Indicator Display (AC: 4, 8)

- [ ] **Display role indicator in header** (AC: 4)
  - [ ] Add role badge or indicator in the dashboard header
  - [ ] Update Header component to show current user role
  - [ ] Style role indicator appropriately for visual hierarchy

- [ ] **Create profile section with user email and role** (AC: 8)
  - [ ] Create user profile component displaying email and role
  - [ ] Add profile access point in navigation or header
  - [ ] Implement proper styling for profile information display

### Permission Tooltips (AC: 5)

- [ ] **Add tooltips explaining permission requirements** (AC: 5)
  - [ ] Implement tooltip component for disabled features
  - [ ] Add explanatory tooltips to admin-only UI elements
  - [ ] Provide clear messaging about role-based restrictions

### Unit Testing (Testing Standards)

- [ ] **Test role-based UI rendering**
  - [ ] Create unit tests for AuthContext with different roles
  - [ ] Test component rendering with admin vs readonly roles
  - [ ] Test tooltip display and content for restricted features
  - [ ] Verify navigation menu adapts correctly for different roles

## Dev Notes

### Previous Story Insights

From Story 2.7 (E2E Testing): The comprehensive testing infrastructure is now available, including authentication helpers and role-based testing patterns. The Page Object Model and test utilities can be leveraged for testing role-based UI behavior.

### Data Models

**User Model**: [Source: architecture/data-models.md#user]

```typescript
interface User {
  userId: string;
  email: string;
  role: 'admin' | 'readonly';
  firstName: string;
  lastName: string;
  lastLogin?: string;
  createdAt: string;
}
```

**JWT Token Claims**: [Source: architecture/core-workflows.md#user-authentication-flow]

- User role is available in JWT token as `custom:role` attribute
- Role validation occurs in Lambda authorizer
- User context passed to frontend via authentication flow

### Component Specifications

**AuthContext Enhancement**: [Source: architecture/frontend-architecture.md#state-management-architecture]

```typescript
// Current AuthContext structure needs role extraction
export interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
}
```

**Component Role Patterns**: [Source: architecture/frontend-architecture.md#component-template]

- Use `useAuth` hook to access user role throughout components
- Implement conditional rendering based on `user?.role === 'admin'`
- Follow existing patterns in InstanceListItem for role-based UI elements

**Protected Route Pattern**: [Source: architecture/frontend-architecture.md#protected-route-pattern]

- ProtectedRoute already supports `requiredRole` parameter
- Role validation pattern established for route-level access control

### File Locations

**Frontend Components**: [Source: architecture/unified-project-structure.md]

- `apps/web/src/store/AuthContext.tsx` - Update auth context with role extraction
- `apps/web/src/components/common/Layout/Header.tsx` - Add role indicator
- `apps/web/src/components/instances/InstanceListItem.tsx` - Update for role-based actions
- `apps/web/src/components/common/` - Create role utility components
- `apps/web/src/hooks/useAuth.ts` - Ensure role access via hook

**Authentication Service**: [Source: architecture/frontend-architecture.md#frontend-services-layer]

- `apps/web/src/services/auth.ts` - Update to extract role from JWT claims

### API Specifications

**JWT Token Structure**: [Source: architecture/backend-architecture.md#authentication-and-authorization]

- Role available in `custom:role` claim from Cognito JWT token
- Lambda authorizer extracts role and passes to downstream services
- Frontend receives role information through authentication response

### Technical Constraints

**Material-UI Patterns**: [Source: architecture/coding-standards.md#material-ui-react-best-practices]

- Never nest block elements inside Typography components
- Use Box with flexbox for role indicator layouts
- Follow established component structure patterns for consistent UI

**State Management**: [Source: architecture/coding-standards.md#critical-fullstack-rules]

- Never mutate state directly - use proper state management patterns
- Store role information in auth context, not component-level state
- Ensure role context is available throughout component tree

**Type Safety**: [Source: architecture/tech-stack.md]

- Use TypeScript for type-safe role checking throughout components
- Define role types consistently with backend User model
- Leverage existing shared type definitions from packages/shared

### Security Considerations

**Client-Side Role Enforcement**: [Source: architecture/core-workflows.md#error-handling-flow]

- Client-side role checks are for UI enhancement only
- Backend still enforces all security through Lambda authorizer
- UI adaptation improves UX but doesn't replace server-side authorization

### Testing

**Testing Standards**: [Source: architecture/testing-strategy.md#frontend-tests]

- **Test Location**: All role-based UI tests in `apps/web/tests/unit/components/` and `apps/web/tests/integration/`
- **Testing Framework**: Jest + React Testing Library for unit tests, existing E2E infrastructure for integration
- **Test Organization**: Follow established patterns in InstanceListItem.test.tsx for role-based component testing
- **Test Data**: Use AuthContext.Provider wrapper with different role values for testing scenarios
- **Assertion Standards**: Test component rendering with different roles using `render` with context providers
- **Role Testing Pattern**: Test both admin and readonly user scenarios for each component
- **E2E Integration**: Leverage existing authentication helpers (`loginUser`) for role-based E2E testing
- **Test Cases**: Verify UI elements hidden/shown correctly, tooltips display appropriate messages, navigation adapts properly

## Change Log

| Date       | Version | Description                          | Author             |
| ---------- | ------- | ------------------------------------ | ------------------ |
| 2025-09-23 | 1.0     | Initial role-based UI story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_This section will be populated by the development agent during implementation_

### Debug Log References

_This section will be populated by the development agent during implementation_

### Completion Notes List

_This section will be populated by the development agent during implementation_

### File List

_This section will be populated by the development agent during implementation_

## QA Results

_This section will be populated by the QA agent after story completion_
