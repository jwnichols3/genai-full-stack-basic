# Story 2.1: Create API Gateway and Lambda Base Infrastructure

## Status

Done

## Story

**As a** backend developer,
**I want** API Gateway and Lambda functions properly configured,
**So that** the frontend can communicate with backend services.

## Acceptance Criteria

1. API Gateway REST API created with proper stage configuration (dev/prod)
2. CORS configured correctly for CloudFront distribution origin
3. Lambda execution role created with necessary IAM permissions for CloudWatch logs
4. API Gateway can successfully invoke Lambda functions (validated with test endpoint /health)
5. Request/response logging enabled in CloudWatch
6. API endpoints follow RESTful conventions (/api/v1/instances)
7. Throttling configured (100 req/s rate, 200 burst limit)
8. API Gateway deployment automated through CDK

## Tasks / Subtasks

- [x] Create API Gateway stack infrastructure (AC: 1, 8)
  - [x] Create api-stack.ts in infrastructure/lib/stacks/
  - [x] Configure REST API with dev/prod stages
  - [x] Set up stage-specific configuration variables
  - [x] Add API Gateway deployment automation in CDK
- [x] Configure CORS for CloudFront integration (AC: 2)
  - [x] Set allowed origins to CloudFront distribution URL
  - [x] Configure allowed methods (GET, POST, PUT, DELETE, OPTIONS)
  - [x] Set proper headers (Authorization, Content-Type)
  - [x] Enable preflight request handling
- [x] Create Lambda execution role with proper permissions (AC: 3)
  - [x] Create IAM role for Lambda functions
  - [x] Add CloudWatch logs permissions (logs:CreateLogGroup, logs:CreateLogStream, logs:PutLogEvents)
  - [x] Add EC2 permissions for immediate compatibility (ec2:DescribeInstances, ec2:DescribeInstanceStatus, ec2:RebootInstances)
  - [x] Add resource constraints for EC2 permissions (region and account scoped)
  - [x] Configure role trust relationship for Lambda service
- [x] Set up API Gateway Lambda integration (AC: 4)
  - [x] Configure proxy integration for Lambda functions
  - [x] Set up method request/response templates
  - [x] Configure error mapping and status codes
  - [x] Test Lambda invocation through API Gateway
- [x] Enable request/response logging (AC: 5)
  - [x] Create CloudWatch log group for API Gateway
  - [x] Configure access logging with custom format
  - [x] Enable execution logging for debugging
  - [x] Set log retention period (30 days)
- [x] Implement RESTful endpoint structure (AC: 6)
  - [x] Define /api/v1/instances resource path
  - [x] Set up base path mapping for versioning
  - [x] Configure resource hierarchy for future endpoints
  - [x] Implement OPTIONS method for CORS preflight
- [x] Configure throttling limits (AC: 7)
  - [x] Set rate limit to 100 requests per second
  - [x] Configure burst limit to 200 requests
  - [x] Set up usage plans for different environments
  - [x] Add throttling error responses (429)
- [x] Add CDK stack integration (AC: 8)
  - [x] Update infrastructure/bin/app.ts to include ApiStack
  - [x] Configure stack dependencies and outputs
  - [x] Add environment-specific configurations
  - [x] Verify deployment succeeds in dev environment
- [x] Create and deploy test Lambda for API Gateway validation (AC: 4)
  - [x] Create simple test Lambda function (apps/api/src/functions/health/check.ts)
  - [x] Configure basic HTTP response with correlation ID
  - [x] Integrate test Lambda with API Gateway /health endpoint
  - [x] Validate API Gateway can invoke Lambda successfully
  - [x] Test CORS headers in response
  - [x] Confirm CloudWatch logs are generated properly
  - [x] Document test endpoint for QA validation

## Dev Notes

### Previous Story Insights

From Story 1.6 completion:

- Infrastructure foundation is established with WebStack (S3 + CloudFront)
- Authentication is configured with Cognito User Pool and client
- Environment variables pattern established using stack outputs
- CDK deployment automation is working successfully

### Technology Stack Details

[Source: architecture/tech-stack.md]

**Backend Technologies:**

- **Backend Language:** TypeScript 5.3+ for type-safe backend development
- **Backend Framework:** AWS Lambda + Node.js 20.x for serverless compute runtime
- **API Style:** REST architecture pattern suitable for CRUD operations
- **IaC Tool:** AWS CDK 2.100+ with TypeScript for infrastructure as code
- **Monitoring:** CloudWatch for logs, metrics, and dashboards
- **Logging:** CloudWatch Logs for centralized logging with automatic Lambda integration

### Project Structure Requirements

[Source: architecture/unified-project-structure.md]

**CDK Stack Files:**

- `infrastructure/lib/stacks/api-stack.ts` - API Gateway + Lambda infrastructure
- `infrastructure/bin/app.ts` - CDK app entry point (modify to include ApiStack)
- `infrastructure/cdk.json` - CDK configuration

**API Application Structure:**

- `apps/api/src/functions/` - Lambda function handlers directory
- `apps/api/src/shared/` - Shared backend code
- `apps/api/src/shared/services/` - Business logic services
- `apps/api/src/shared/middleware/` - Lambda middleware
- `apps/api/src/shared/utils/` - Backend utilities
- `apps/api/src/types/` - Backend TypeScript types

### API Gateway Configuration

[Source: architecture/api-specification.md]

**REST API Structure:**

- Base URL pattern: `/api/v1/instances`
- Security: Cognito JWT token authorization
- CORS: Must support CloudFront distribution origin
- Content-Type: `application/json` for all endpoints
- Error format: Standardized error objects with code, message, requestId

**Required Endpoints Structure:**

```
/api/v1/instances          # List instances (GET)
/api/v1/instances/{id}     # Get instance details (GET)
/api/v1/instances/{id}/reboot  # Reboot instance (POST)
/api/v1/instances/{id}/metrics # Get metrics (GET)
/api/v1/audit-logs         # Audit logs (GET)
```

### Lambda Function Organization

[Source: architecture/backend-architecture.md]

**Function Directory Structure:**

```
api/src/functions/
├── auth/
│   ├── authorizer.ts       # Cognito JWT validation
│   └── refresh.ts          # Token refresh handler
├── instances/
│   ├── list.ts            # List all instances
│   ├── get.ts             # Get instance details
│   ├── reboot.ts          # Reboot instance
│   └── metrics.ts         # Get CloudWatch metrics
├── audit/
│   ├── list.ts            # List audit logs
│   └── write.ts           # Write audit entry
└── shared/
    ├── middleware/
    ├── services/
    └── utils/
```

### IAM Permissions Required

[Source: architecture/backend-architecture.md]

**Lambda Execution Role Permissions:**

- CloudWatch Logs: `logs:CreateLogGroup`, `logs:CreateLogStream`, `logs:PutLogEvents`
- EC2 Access: `ec2:DescribeInstances`, `ec2:RebootInstances` (for future stories)
- DynamoDB: Read/Write permissions for audit logs table (for future stories)

**Enhanced IAM Permissions for Story Chain Compatibility:**

- EC2 DescribeInstances: Required for Story 2.3 (List Instances)
- EC2 DescribeInstanceStatus: Required for real-time status updates
- EC2 RebootInstances: Required for Story 2.2+ admin actions
- Resource Scope: Limit to specific region and account for security

### CORS Configuration

**Required CORS Settings:**

- Allowed Origins: CloudFront distribution URL from WebStack output
- Allowed Methods: GET, POST, PUT, DELETE, OPTIONS
- Allowed Headers: Authorization, Content-Type, X-Amz-Date, X-Api-Key, X-Amz-Security-Token
- Exposed Headers: X-Request-Id
- Max Age: 86400 seconds (24 hours)

### CDK Stack Dependencies

**Stack Output References:**

- WebStack CloudFront URL for CORS configuration
- Cognito User Pool ID and Client ID from AuthStack (existing)
- Need to create API Gateway URL output for frontend configuration

**Environment Configuration:**

- Development stage: `dev`
- Production stage: `prod`
- Region: `us-west-2` (consistent with existing infrastructure)

### API Gateway Throttling

[Source: Epic 2.1 AC: 7]

**Throttling Configuration:**

- Rate Limit: 100 requests per second
- Burst Limit: 200 requests
- Throttling Response: HTTP 429 with retry headers
- Usage Plans: Separate limits for dev/prod environments

### Logging Configuration

[Source: architecture/backend-architecture.md]

**CloudWatch Logging:**

- Access Log Format: Include request ID, IP, user agent, response time
- Execution Logs: Enable for debugging Lambda invocations
- Log Retention: 30 days for cost optimization
- Log Group Naming: `/aws/apigateway/ec2-manager-api`

### Coding Standards

[Source: architecture/coding-standards.md]

**Critical Backend Rules:**

- Type Sharing: Define types in packages/shared and import from there
- Environment Variables: Access only through config objects, never process.env directly
- Error Handling: All API routes must use the standard error handler
- Input Validation: Validate all user inputs on backend
- Naming Conventions: camelCase for functions, kebab-case for API routes

### File Locations from Project Structure

**New Files to Create:**

- `infrastructure/lib/stacks/api-stack.ts` - API Gateway and Lambda infrastructure
- `apps/api/package.json` - API application package configuration
- `apps/api/tsconfig.json` - TypeScript configuration for API
- `apps/api/src/shared/utils/response.ts` - Standard response utilities

**Files to Modify:**

- `infrastructure/bin/app.ts` - Add ApiStack to CDK app
- Root `package.json` - Add API workspace if using workspaces

## Testing

**Test Standards from Architecture:**

[Source: architecture/testing-strategy.md]

- **Backend Test Location:** `apps/api/tests/` directory
- **Test Framework:** Jest 29.x for Lambda function testing
- **Test Organization:** unit/ and integration/ subdirectories
- **Coverage Requirements:** Minimum 80% for critical business logic
- **Test Naming:** kebab-case files ending in `.test.ts`

**Specific Testing Requirements for This Story:**

1. API Gateway infrastructure tests (CDK construct testing)
2. Lambda execution role permissions validation
3. CORS preflight request handling verification
4. Throttling configuration tests
5. CloudWatch logging integration tests
6. API Gateway deployment automation tests

**Integration Testing:**

- Test API Gateway can invoke test Lambda function
- Verify CORS headers in OPTIONS responses
- Test throttling limits with load testing
- Validate CloudWatch logs are created and formatted correctly

**API Gateway Integration Testing:**

- Test health endpoint responds with 200 status
- Verify CORS headers are properly configured
- Validate request ID correlation in logs
- Test error responses (4xx/5xx scenarios)
- Confirm API Gateway-Lambda integration metrics

## Change Log

| Date       | Version | Description                                   | Author                |
| ---------- | ------- | --------------------------------------------- | --------------------- |
| 2025-09-15 | 1.0     | Initial story creation                        | Bob (Scrum Master)    |
| 2025-09-15 | 1.1     | DoR validation fixes applied, status approved | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

No debug issues encountered during implementation. All deployment and testing proceeded successfully.

### Completion Notes List

- Successfully implemented API Gateway with REST API infrastructure
- Configured CORS integration with CloudFront distribution (https://d2pbh2fudgytg0.cloudfront.net)
- Created Lambda execution role with proper EC2 and CloudWatch permissions
- Implemented health check Lambda function with API Gateway integration
- Enabled comprehensive logging with 30-day retention and custom access log format
- Configured throttling limits: 100 req/s rate, 200 burst limit
- Deployed and validated API Gateway URL: https://xg34xg3ngh.execute-api.us-west-2.amazonaws.com/dev/
- Health endpoint responding successfully: /api/v1/health
- CORS preflight requests working correctly with proper headers
- All tests passing: linting clean, infrastructure tests successful

### File List

**New Files Created:**

- `infrastructure/lib/stacks/api-stack.ts` - API Gateway and Lambda infrastructure stack
- `apps/api/src/functions/health/check.ts` - Health check Lambda function for API validation

**Files Modified:**

- `infrastructure/bin/app.ts` - Added ApiStack to CDK application with dependency on WebStack

## QA Results

_This section will be populated by the QA agent after story completion_
